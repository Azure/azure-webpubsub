<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js" integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js" integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc" crossorigin="anonymous"></script>

    <style>
        .userId {
            padding: 10px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .connectionId {
            text-align: center;
            font-size: 10px;
            color: #CCC;
        }
        
        .main {
            padding: 10px;
        }
        
        .main .chat-box {
            border: 1px solid;
            height: 500px;
        }
        
        .message .info {
            text-align: center;
        }
        
        .message .info.join {
            background-color: #9F9;
        }
        
        .message .info.leave {
            background-color: #FF9;
        }
        
        .message .user {
            margin: 0 10px;
            color: #999;
        }
        
        .message .content {
            margin-left: 20px;
        }
        
        .controller {
            padding: 0 10px;
        }
    </style>

</head>

<body>
    <div id="app">
        <div class="userId">Hello, {{user.userId}} !</div>
        <div class="connectionId">{{user.connectionId}}</div>

        <div class="main">
            <div class="chat-box">
                <div class="message" v-for="message in messages">
                    <div v-if="message.join" class="info join">xxxxx joined the group A</div>
                    <div v-if="message.leave" class="info leave">xxxxx left the group B</div>
                    <div v-if="message.content" class="user">{{message.userId}} Says: <span v-if="message.group">[from: {{message.group}}]</span></div>
                    <div v-if="message.content" class="content">{{message.content}}</div>
                </div>
            </div>
        </div>

        <form class="controller">
            <label class="form-label">Group & Permission Control</label>
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Group name..." v-model="form.group">
                <button class="btn btn-primary" type="Join" v-on:click="join">Join</button>
                <button class="btn btn-outline-secondary" type="Leave" v-on:click="leave">Leave</button>
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Action: {{form.action}}</button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" v-for="action in actions" v-on:click="selectAction(action)">{{action}}</a></li>
                </ul>
                <button class="btn btn-primary" type="Join" v-on:click="grant">Grant</button>
                <button class="btn btn-outline-secondary" type="Leave" v-on:click="revoke">Revoke</button>
            </div>
        </form>

        <form v-on:submit="send" class="controller">
            <label class="form-label">Messaging</label>
            <div class="input-group mb-3">
                <input type="text" placeholder="Say something..." class="form-control" v-model="form.message">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">{{form.group || "none"}}</button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" v-on:click="select('default')" href="#">default</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" v-for="group in groups" href="#" v-on:click="select(group)">{{group}}</a></li>
                </ul>
                <button class="btn btn-primary" type="submit" id="button-addon2">Send</button>
            </div>
        </form>

    </div>

    <script>
        let ackId = 1;

        function GetAckId() {
            return ackId++;
        }

        var app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue!',
                user: {
                    userId: "",
                    connectionId: "-----------------------------------------",
                },
                form: {
                    group: "default",
                    message: "",
                    action: "SendToGroup",
                },
                groups: [
                    "Test Group A",
                    "Test Group B",
                ],
                actions: [
                    "SendToGroup",
                    "JoinLeaveGroup",
                ],
                messages: []
            },
            methods: {
                send: function(e) {
                    let data = {
                        type: "sendToGroup",
                        group: this.form.group,
                        dataType: "json",
                        ackId: GetAckId(),
                        data: {
                            userId: this.user.userId,
                            content: this.form.message,
                        }
                    }
                    this.ws.send(JSON.stringify(data))
                },
                join: function(e) {
                    let data = {
                        type: "joinGroup",
                        group: this.form.group,
                        dataType: "text",
                        ackId: GetAckId(),
                    }
                    this.ws.send(JSON.stringify(data))
                },
                leave: function(e) {
                    let data = {
                        type: "leaveGroup",
                        group: this.form.group,
                        dataType: "text",
                        ackId: GetAckId(),
                    }
                    this.ws.send(JSON.stringify(data))
                },
                grant: async function(e) {
                    let res = await fetch("/permission", {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            connectionId: this.user.connectionId,
                            group: this.form.group,
                            action: this.form.action,
                        })
                    })
                    if (res.status != 200) {
                        alert("internal server error");
                        return;
                    }
                    let data = await res.json()
                    if (data.success) {
                        alert("permission granted!")
                    }
                },
                revoke: async function(e) {
                    let res = await fetch("/permission", {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            connectionId: this.user.connectionId,
                            group: this.form.group,
                            action: this.form.action,
                        })
                    })
                    if (res.status != 200) {
                        alert("internal server error");
                        return;
                    }
                    let data = await res.json()
                    if (data.success) {
                        alert("permission revoked!")
                    }
                },
                select: function(group) {
                    app.form.group = group;
                },
                selectAction: function(action) {
                    app.form.action = action;
                }
            }
        })

        async function connect() {
            let res = await fetch(`http://localhost:5050/negotiate`);
            let data = await res.json();
            let ws = new WebSocket(data.url, 'json.webpubsub.azure.v1');

            ws.onmessage = e => {
                let data = JSON.parse(e.data)

                switch (data.type) {
                    case "message":
                        if (data.from == "server") {
                            app.user = data.data
                        } else {
                            let message = data.data
                            message.group = data.group;
                            console.log(message)
                            app.messages.push(message)
                        }
                        break;
                    case "ack":
                        if (!data.success) {
                            alert(data.error);
                        }
                        break;
                }
            }

            app.ws = ws;
        }

        connect()
    </script>
</body>

</html>