name: chat-demo
metadata:
  template: chat-demo
infra:
  provider: bicep
  path: infra
  # To override the default web app name (<baseName>-web), set parameter:
  # parameters:
  #   webAppNameOverride: your-custom-name
    # To override (or guarantee uniqueness for) the Web PubSub service name:
    # azd provision --set webPubSubNameOverride=myuniquewpsname123
services:
  chatserver:
    # Use python_server as the project root so Oryx clearly detects Python (avoids Node-only detection due to root package.json)
    project: python_server
    language: python
    host: appservice
    # Frontend build hook (build React and copy static files) - ensure this exists in project root or scripts
    hooks:
      prepackage:
        windows:
          shell: pwsh
          run: |
            Push-Location ..\client
            if (Test-Path node_modules) {
              Write-Host "Reusing existing node_modules" 
            } else {
              Write-Host "Installing dependencies in client/" 
              npm install
            }
            npm run build
            Pop-Location
            if (Test-Path static) { Remove-Item -Recurse -Force static }
            Copy-Item -Recurse ..\client\dist static
        posix:
          shell: sh
          run: |
            (cd ../client && ([ -d node_modules ] || npm install) && npm run build)
            rm -rf static
            cp -R ../client/dist static
